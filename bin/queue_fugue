#!/usr/bin/env ruby

require 'optparse'
require 'methadone'

$LOAD_PATH << File.join(File.dirname(__FILE__), '..', 'lib')
require 'application'
require 'jfugue_note_player'
require 'instruments'

class App
  include Methadone::Main
  include Methadone::CLILogging
  
  main do |server_address, queue_name|
    app = QueueFugueApp.new(JFugueNotePlayer.new(instruments))
    
    server_url = construct_server_url(server_address)
    info "Starting playing from queue [#{queue_name}] on [#{server_url}]"
    
    app.start server_url, queue_name
    trap('INT') do
      info "\nGood-bye!"
      app.stop!
    end
    app.loop
  end
  
  def self.construct_server_url(address)
    "tcp://#{address}:61616"
  end
  
  def self.instruments
    inst = Instruments.new
    inst.add_mapping 'O', 'ACOUSTIC_SNARE'
    inst.add_mapping '*', 'BASS_DRUM'
    inst.add_mapping '+', 'CRASH_CYMBAL_1'
    inst
  end
  
  description 'Play a rhythm inspired by your ActiveMQ load'
  
  arg :server_address
  arg :queue_name
  
  version '0.0.1'
  
  use_log_level_option
  
  go!
end
